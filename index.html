<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decisiv Case Notation Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            color: #e0e6ed;
        }

        .main-layout {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            width: 100%;
            align-items: flex-start;
        }

        .sidebar {
            flex: 0 0 320px;
            position: sticky;
            top: 100px;
        }

        .container {
            background: rgba(15, 15, 35, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px 40px 40px 40px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 100px;
            flex: 1;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .intro-text {
            color: #b0bec5;
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            color: #e0e6ed;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e6ed;
            backdrop-filter: blur(10px);
        }

        .form-group input:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 
                0 0 0 3px rgba(100, 255, 218, 0.1),
                0 0 20px rgba(100, 255, 218, 0.2);
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group input::placeholder {
            color: #78909c;
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .button-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            padding: 10px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .button-wrapper:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(100, 255, 218, 0.2);
            transform: translateY(-2px);
        }

        .descriptor-bubble {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            color: #64ffda;
            font-size: 0.95em;
            line-height: 1.4;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(100, 255, 218, 0.1);
            flex: 1;
            min-width: 250px;
            text-align: left;
        }

        .descriptor-bubble strong {
            display: block;
            margin-bottom: 6px;
            color: #ffffff;
            font-size: 1.05em;
        }

        .mailto-btn {
            padding: 20px 30px;
            border: none;
            border-radius: 16px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            min-width: 280px;
            white-space: nowrap;
        }

        .mailto-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .mailto-btn:hover:before {
            left: 100%;
        }

        .mailto-btn:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mailto-btn:hover:after {
            opacity: 1;
        }

        .btn-note {
            background: linear-gradient(135deg, #00e676 0%, #00c853 50%, #1de9b6 100%);
            box-shadow: 
                0 8px 32px rgba(0, 230, 118, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .btn-note:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(0, 230, 118, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #00e676 0%, #00c853 30%, #1de9b6 100%);
        }

        .btn-attachment {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 50%, #00bcd4 100%);
            box-shadow: 
                0 8px 32px rgba(33, 150, 243, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .btn-attachment:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(33, 150, 243, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 30%, #00bcd4 100%);
        }

        .btn-status {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ffc107 100%);
            box-shadow: 
                0 8px 32px rgba(255, 107, 53, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .btn-status:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(255, 107, 53, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 30%, #ffc107 100%);
        }

        .btn-icon {
            margin-right: 10px;
            font-size: 1.3em;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }

        .mailto-btn:hover .btn-icon {
            transform: scale(1.1);
        }

        .error-message {
            color: #ff5252;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 12px 16px;
            background: rgba(255, 82, 82, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: 12px;
            display: none;
            box-shadow: 
                0 4px 16px rgba(255, 82, 82, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
        }

        .modal h3 {
            color: #64ffda;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .modal-content {
            margin-bottom: 25px;
        }

        .case-input-group {
            margin-bottom: 20px;
        }

        .case-input-group label {
            display: block;
            color: #e0e6ed;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .case-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e6ed;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .case-input-group input:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.1);
        }

        .case-input-group input.error {
            border-color: #ff5252;
            box-shadow: 0 0 0 3px rgba(255, 82, 82, 0.1);
        }

        .input-error {
            color: #ff5252;
            font-size: 0.85em;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .radio-group {
            margin-bottom: 20px;
        }

        .radio-group h4 {
            color: #e0e6ed;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #64ffda;
        }

        .radio-option input[type="radio"],
        .radio-option input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .radio-option label {
            color: #e0e6ed;
            font-size: 1em;
            cursor: pointer;
            flex: 1;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #00e676 0%, #00c853 50%, #1de9b6 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #00e676 0%, #00c853 30%, #1de9b6 100%);
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* User Guide Modal Styles */
        .user-guide-modal {
            background: rgba(15, 15, 35, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            width: 1000px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            display: flex;
            flex-direction: column;
        }

        .user-guide-header {
            background: linear-gradient(135deg, #00e676 0%, #00c853 50%, #1de9b6 100%);
            padding: 20px 30px;
            border-radius: 24px 24px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-guide-header h2 {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
            margin: 0;
        }

        .close-guide-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-guide-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .user-guide-content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            line-height: 1.6;
        }

        .user-guide-content h1 {
            color: #00e676;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 230, 118, 0.3);
            padding-bottom: 10px;
        }

        .user-guide-content h2 {
            color: #64ffda;
            font-size: 1.4em;
            margin: 25px 0 15px 0;
        }

        .user-guide-content h3 {
            color: #b0bec5;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
        }

        .user-guide-content h4 {
            color: #e0e6ed;
            font-size: 1.1em;
            margin: 15px 0 8px 0;
        }

        .user-guide-content p {
            margin-bottom: 15px;
            color: #b0bec5;
        }

        .user-guide-content ul, .user-guide-content ol {
            margin: 15px 0 15px 20px;
            color: #b0bec5;
        }

        .user-guide-content li {
            margin-bottom: 8px;
        }

        .user-guide-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        .user-guide-content th {
            background: rgba(0, 230, 118, 0.2);
            color: #00e676;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .user-guide-content td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #b0bec5;
        }

        .user-guide-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #64ffda;
        }

        .user-guide-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #00e676;
        }

        .user-guide-content blockquote {
            border-left: 4px solid #64ffda;
            padding-left: 15px;
            margin: 15px 0;
            color: #64ffda;
            font-style: italic;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 2500;
            pointer-events: none;
        }

        .toast {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 10px;
            max-width: 350px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #00e676;
            box-shadow: 0 8px 32px rgba(0, 230, 118, 0.2);
        }

        .toast.error {
            border-left: 4px solid #ff5252;
            box-shadow: 0 8px 32px rgba(255, 82, 82, 0.2);
        }

        .toast.warning {
            border-left: 4px solid #ffc107;
            box-shadow: 0 8px 32px rgba(255, 193, 7, 0.2);
        }

        .toast.info {
            border-left: 4px solid #2196f3;
            box-shadow: 0 8px 32px rgba(33, 150, 243, 0.2);
        }

        .toast-icon {
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: #00e676;
        }

        .toast.error .toast-icon {
            color: #ff5252;
        }

        .toast.warning .toast-icon {
            color: #ffc107;
        }

        .toast.info .toast-icon {
            color: #2196f3;
        }

        .toast-content {
            flex: 1;
            color: #e0e6ed;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .toast-message {
            font-size: 0.85em;
            color: #b0bec5;
            line-height: 1.3;
        }

        .toast-close {
            background: none;
            border: none;
            color: #78909c;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
        }

        /* Help Button Styles */
        .help-button {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 50%, #00bcd4 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.6);
        }

        @media (max-width: 768px) {
            .user-guide-modal {
                width: 95vw;
                max-height: 85vh;
            }
            
            .user-guide-header {
                padding: 15px 20px;
            }
            
            .user-guide-content {
                padding: 20px;
            }
            
            .help-button {
                bottom: 85px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.3em;
            }
        }

        /* Footer Disclaimer Styles */
        .footer-disclaimer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(139, 69, 19, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 165, 0, 0.3);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .disclaimer-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .disclaimer-icon {
            width: 24px;
            height: 24px;
            background: #ff6b35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .disclaimer-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .disclaimer-title {
            color: #ffa500;
            font-weight: 700;
            font-size: 0.9em;
        }

        .disclaimer-text {
            color: #ffcc80;
            font-size: 0.8em;
            line-height: 1.2;
        }

        .disclaimer-right {
            color: #b0bec5;
            font-size: 0.8em;
            text-align: right;
        }

        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .header-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 2;
        }

        .header-center h1 {
            color: #ffffff;
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(45deg, #64ffda, #00bcd4, #2196f3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(100, 255, 218, 0.3);
            text-align: center;
        }

        .kenworth-logo {
            height: 40px;
            width: auto;
            filter: brightness(1.1);
        }

        .service-dept-text {
            color: #64ffda;
            font-size: 1.3em;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex: 1;
        }

        .decisiv-logo {
            height: 35px;
            width: auto;
            filter: brightness(1.2);
        }

        body {
            padding-top: 80px;
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
                gap: 20px;
            }

            .sidebar {
                flex: none;
                position: static;
                width: 100%;
            }

            .container {
                max-width: 100%;
                padding: 20px;
                margin: 0;
                margin-bottom: 120px;
            }

            .button-wrapper {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .mailto-btn {
                min-width: auto;
                width: 100%;
                padding: 18px 24px;
                font-size: 1em;
                white-space: normal;
                text-align: center;
            }

            .descriptor-bubble {
                min-width: auto;
                text-align: center;
                width: 100%;
            }

            .disclaimer-left {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .disclaimer-content {
                gap: 1px;
            }

            .disclaimer-title {
                font-size: 0.8em;
            }

            .disclaimer-text {
                font-size: 0.75em;
            }

            .disclaimer-right {
                font-size: 0.75em;
                text-align: left;
            }

            .footer-disclaimer {
                padding: 10px 15px;
                flex-direction: column;
                gap: 8px;
            }

            .header-center h1 {
                font-size: 1.6em;
            }

            .location-options {
                gap: 10px;
            }
        }

        @media (max-width: 600px) {
            .top-header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 8px;
            }

            .header-left {
                gap: 10px;
                justify-content: center;
            }

            .header-center {
                order: -1;
            }

            .header-center h1 {
                font-size: 1.4em;
            }

            .header-right {
                justify-content: center;
            }

            .service-dept-text {
                font-size: 1.1em;
            }

            .kenworth-logo {
                height: 30px;
            }

            .decisiv-logo {
                height: 28px;
            }

            body {
                padding-top: 120px;
                padding-bottom: 100px;
            }

            .btn-icon {
                font-size: 1.2em;
            }
        }

        /* Location Selection Styles */
        .location-selection {
            padding: 25px;
            background: rgba(15, 15, 35, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        .location-selection h3 {
            color: #00e676;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
        }

        .location-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .location-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .location-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 230, 118, 0.3);
            transform: translateY(-2px);
        }

        .location-option input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            accent-color: #00e676;
            cursor: pointer;
        }

        .location-option label {
            color: #e0e6ed;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }

        .location-option.selected {
            background: rgba(0, 230, 118, 0.15);
            border-color: #00e676;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.2);
        }

        .location-option.selected label {
            color: #00e676;
        }

        .location-status {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: #b0bec5;
            font-size: 0.9em;
        }

        .loading-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .location-options {
                gap: 10px;
            }
            
            .location-selection {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="top-header">
        <div class="header-left">
            <img src="https://www.kenworth.com/media/w4jnzm4t/kenworth_logo-header-new-012023.png" 
                 alt="Kenworth Logo" 
                 class="kenworth-logo">
            <span class="service-dept-text">WKI Service Dept.</span>
        </div>
        <div class="header-center">
            <h1>Decisiv Case Notation Tool</h1>
        </div>
        <div class="header-right">
            <img src="https://www.decisiv.com/wp-content/uploads/2020/01/Decisiv-Logo-096126.svg" 
                 alt="Decisiv Logo" 
                 class="decisiv-logo">
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Help Button -->
    <button class="help-button" onclick="openUserGuide()" title="User Guide">
        ‚ùì
    </button>
    
    <div class="main-layout">
        <!-- Sidebar with Location Selection -->
        <div class="sidebar">
            <div class="location-selection">
                <h3>Select Your Location</h3>
                <div class="location-status" id="locationStatus" style="display: none;">
                    <span class="loading-spinner">üîÑ</span> Detecting your location...
                </div>
                <div class="location-options">
                    <div class="location-option" onclick="selectLocation('wichita')">
                        <input type="radio" id="location-wichita" name="location" value="wichita" checked onchange="updateLocationEmails()">
                        <label for="location-wichita">Wichita</label>
                    </div>
                    <div class="location-option" onclick="selectLocation('dodge-city')">
                        <input type="radio" id="location-dodge-city" name="location" value="dodge-city" onchange="updateLocationEmails()">
                        <label for="location-dodge-city">Dodge City</label>
                    </div>
                    <div class="location-option" onclick="selectLocation('liberal')">
                        <input type="radio" id="location-liberal" name="location" value="liberal" onchange="updateLocationEmails()">
                        <label for="location-liberal">Liberal</label>
                    </div>
                    <div class="location-option" onclick="selectLocation('emporia')">
                        <input type="radio" id="location-emporia" name="location" value="emporia" onchange="updateLocationEmails()">
                        <label for="location-emporia">Emporia</label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Container -->
        <div class="container">
            <p class="intro-text">Click a button below to create email notations for Decisiv cases. You'll be prompted to enter the case number.</p>
            <p class="intro-text" style="font-size: 0.95em; color: #78909c; margin-top: -15px; margin-bottom: 35px;">
                üí° <strong>Tip:</strong> You can attach images, log files, documents, or other relevant files to any email generated by this tool to include them in your case.
            </p>

            <div class="buttons-container">
            <div class="button-wrapper">
                <button class="mailto-btn btn-note" onclick="createMailto('note')">
                    <span class="btn-icon">üìù</span>
                    Add Note
                </button>
                <div class="descriptor-bubble">
                    <strong>Simple Note Addition</strong>
                    Sends to: Decisiv Case Update only
                </div>
            </div>

            <div class="button-wrapper">
                <button class="mailto-btn btn-attachment" onclick="createMailto('notify')">
                    <span class="btn-icon">üìé</span>
                    Add Note and Notify
                </button>
                <div class="descriptor-bubble">
                    <strong>Note with Team Notification</strong>
                    Sends to: Decisiv Case Update + Back Parts Counter or Service Admin Team
                </div>
            </div>

            <div class="button-wrapper">
                <button class="mailto-btn btn-status" onclick="createMailto('status')">
                    <span class="btn-icon">üîß</span>
                    Service Diag and Parts Update
                </button>
                <div class="descriptor-bubble">
                    <strong>Service Diagnosis Report</strong>
                    Sends to: Decisiv Case Update + Back Parts Counter
                </div>
            </div>
        </div>

            <div class="error-message" id="errorMessage">
                Please enter a valid case number (numbers only).
            </div>
        </div>
    </div>

    <!-- Footer Disclaimer -->
    <div class="footer-disclaimer">
        <div class="disclaimer-left">
            <div class="disclaimer-icon">!</div>
            <div class="disclaimer-content">
                <div class="disclaimer-title">WKI Proprietary Application</div>
                <div class="disclaimer-text">This application is proprietary to WKI and contains confidential business information. Unauthorized access, use, or distribution is strictly prohibited.</div>
            </div>
        </div>
        <div class="disclaimer-right">
            Built for WKI Service Department Excellence<br>
            Email Communication Tool ‚Ä¢ Professional Case Management ‚Ä¢ WKI Internal Use Only
        </div>
    </div>

    <!-- Case Number Input Modal -->
    <div class="modal-overlay" id="caseNumberModal">
        <div class="modal">
            <h3 id="caseModalTitle">Enter Case Number</h3>
            <div class="modal-content">
                <div class="case-input-group">
                    <label for="caseNumberInput">Decisiv Case Number:</label>
                    <input type="text" id="caseNumberInput" placeholder="Enter case number (numbers only)" maxlength="10">
                    <div class="input-error" id="caseNumberError" style="display: none;">
                        Please enter a valid case number (numbers only, 3-10 digits)
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="processCaseNumber()">Continue</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeCaseNumberModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Email Notification Modal -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal">
            <h3>Add Note and Notify</h3>
            <div class="modal-content">
                <div class="case-input-group">
                    <label for="modalCaseNumber">Case Number:</label>
                    <input type="text" id="modalCaseNumber" placeholder="Enter case number">
                </div>
                
                <div class="radio-group">
                    <h4>Select who to notify (check all that apply):</h4>
                    <div class="radio-option">
                        <input type="checkbox" id="backPartsCounter" name="notifyEmail" value="WIC-BPC@WichitaKenworth.com">
                        <label for="backPartsCounter">Back Parts Counter</label>
                    </div>
                    <div class="radio-option">
                        <input type="checkbox" id="serviceAdminTeam" name="notifyEmail" value="WichitaServiceAdmin@WichitaKenworth.com">
                        <label for="serviceAdminTeam">Service Admin Team</label>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="processNotificationEmail()">Generate Email</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Guide Modal -->
    <div class="modal-overlay" id="userGuideModal">
        <div class="user-guide-modal">
            <div class="user-guide-header">
                <h2>üìã Decisiv Case Notation Tool - User Guide</h2>
                <button class="close-guide-btn" onclick="closeUserGuide()">√ó</button>
            </div>
            <div class="user-guide-content" id="userGuideContent">
                <!-- User guide content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Toast notification system
        /**
         * Shows a toast notification to the user
         * @param {string} type - Type of toast ('success', 'error', 'warning', 'info')
         * @param {string} title - Toast title
         * @param {string} message - Toast message
         * @param {number} duration - Duration in milliseconds (default: 5000)
         */
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => removeToast(toast), duration);
            }
            
            return toast;
        }

        /**
         * Removes a toast notification
         * @param {HTMLElement} toast - Toast element to remove
         */
        function removeToast(toast) {
            if (toast && toast.parentElement) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }
        }

        // Enhanced case number validation
        /**
         * Validates a case number input
         * @param {string} caseNumber - Case number to validate
         * @returns {Object} Validation result with isValid boolean and error message
         */
        function validateCaseNumber(caseNumber) {
            if (!caseNumber || caseNumber.trim() === '') {
                return { isValid: false, error: 'Case number is required' };
            }
            
            const cleaned = caseNumber.replace(/\D/g, '');
            
            if (cleaned === '') {
                return { isValid: false, error: 'Case number must contain only numbers' };
            }
            
            if (cleaned.length < 3) {
                return { isValid: false, error: 'Case number must be at least 3 digits' };
            }
            
            if (cleaned.length > 10) {
                return { isValid: false, error: 'Case number must be no more than 10 digits' };
            }
            
            return { isValid: true, cleaned: cleaned };
        }

        // Case number modal management
        let currentEmailType = null;
        let currentSelectedEmails = null;

        /**
         * Opens the case number input modal
         * @param {string} type - Email type ('note', 'notify', 'status')
         * @param {Array} selectedEmails - Selected email addresses for notify type
         */
        function openCaseNumberModal(type, selectedEmails = null) {
            currentEmailType = type;
            currentSelectedEmails = selectedEmails;
            
            const modal = document.getElementById('caseNumberModal');
            const title = document.getElementById('caseModalTitle');
            const input = document.getElementById('caseNumberInput');
            const error = document.getElementById('caseNumberError');
            
            // Set appropriate title based on email type
            const titles = {
                note: 'Enter Case Number - Add Note',
                notify: 'Enter Case Number - Add Note and Notify',
                status: 'Enter Case Number - Service Diagnosis'
            };
            
            title.textContent = titles[type] || 'Enter Case Number';
            
            // Clear previous input and errors
            input.value = '';
            input.classList.remove('error');
            error.style.display = 'none';
            
            modal.style.display = 'flex';
            
            // Focus on input
            setTimeout(() => input.focus(), 100);
        }

        /**
         * Closes the case number modal
         */
        function closeCaseNumberModal() {
            const modal = document.getElementById('caseNumberModal');
            modal.style.display = 'none';
            currentEmailType = null;
            currentSelectedEmails = null;
        }

        /**
         * Processes the case number input from the modal
         */
        function processCaseNumber() {
            const input = document.getElementById('caseNumberInput');
            const error = document.getElementById('caseNumberError');
            const caseNumber = input.value.trim();
            
            const validation = validateCaseNumber(caseNumber);
            
            if (!validation.isValid) {
                input.classList.add('error');
                error.textContent = validation.error;
                error.style.display = 'block';
                return;
            }
            
            // Clear error state
            input.classList.remove('error');
            error.style.display = 'none';
            
            // Close modal
            closeCaseNumberModal();
            
            // Process the email
            try {
                processEmail(currentEmailType, validation.cleaned, currentSelectedEmails);
                showToast('success', 'Email Generated', 'Your email client should open with the pre-filled case notation.');
            } catch (err) {
                console.error('Error processing email:', err);
                showToast('error', 'Email Error', 'There was an error generating the email. Please try again.');
            }
        }

        // Location-specific email configuration
        const locationConfig = {
            'wichita': {
                bpc: 'WIC-BPC@WichitaKenworth.com',
                serviceAdmin: 'WichitaServiceAdmin@WichitaKenworth.com',
                coords: { lat: 37.6872, lng: -97.3301 }, // Wichita, KS
                city: 'Wichita',
                state: 'KS'
            },
            'dodge-city': {
                bpc: 'DOD-BPC@DodgeCityKenworth.com',
                serviceAdmin: 'DCServiceAdmin@DodgeCityKenworth.com',
                coords: { lat: 37.7528, lng: -100.0171 }, // Dodge City, KS
                city: 'Dodge City',
                state: 'KS'
            },
            'liberal': {
                bpc: 'LIB-BPC@LiberalKenworth.com',
                serviceAdmin: 'LiberalServiceAdmin@WichitaKenworth.com',
                coords: { lat: 37.0431, lng: -100.9210 }, // Liberal, KS
                city: 'Liberal',
                state: 'KS'
            },
            'emporia': {
                bpc: 'Parts@EmporiaKenworth.com',
                serviceAdmin: 'EmporiaServiceAdmin@WichitaKenworth.com',
                coords: { lat: 38.4039, lng: -96.1817 }, // Emporia, KS
                city: 'Emporia',
                state: 'KS'
            }
        };

        /**
         * Calculate distance between two coordinates using the Haversine formula
         * @param {number} lat1 - Latitude of first point
         * @param {number} lng1 - Longitude of first point  
         * @param {number} lat2 - Latitude of second point
         * @param {number} lng2 - Longitude of second point
         * @returns {number} Distance in miles
         */
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        /**
         * Find the closest WKI location based on coordinates
         * @param {number} userLat - User's latitude
         * @param {number} userLng - User's longitude
         * @returns {Object} Object with location key and distance
         */
        function findClosestLocation(userLat, userLng) {
            let closestLocation = 'wichita';
            let shortestDistance = Infinity;

            for (const [locationKey, locationData] of Object.entries(locationConfig)) {
                const distance = calculateDistance(
                    userLat, userLng,
                    locationData.coords.lat, locationData.coords.lng
                );
                
                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    closestLocation = locationKey;
                }
            }

            return { location: closestLocation, distance: shortestDistance };
        }

        /**
         * Attempt to detect location using HTML5 Geolocation with enhanced error handling
         * @returns {Promise<string>} Detected location key
         */
        function detectLocationByGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported by this browser'));
                    return;
                }

                const options = {
                    timeout: 10000,
                    enableHighAccuracy: true,
                    maximumAge: 300000 // 5 minutes cache
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        try {
                            const { latitude, longitude } = position.coords;
                            const result = findClosestLocation(latitude, longitude);
                            console.log(`Geolocation detected: ${latitude}, ${longitude}`);
                            console.log(`Closest location: ${result.location} (${result.distance.toFixed(1)} miles away)`);
                            resolve(result.location);
                        } catch (error) {
                            console.error('Error processing geolocation result:', error);
                            reject(error);
                        }
                    },
                    (error) => {
                        let errorMessage = 'Unknown geolocation error';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location access denied by user';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out';
                                break;
                        }
                        console.log('Geolocation error:', errorMessage);
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        }

        /**
         * Attempt to detect location using IP-based geolocation with enhanced error handling
         * @returns {Promise<string>} Detected location key
         */
        async function detectLocationByIP() {
            try {
                console.log('Attempting IP-based location detection...');
                
                // Using ipapi.co - free tier allows 1000 requests/day
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const response = await fetch('https://ipapi.co/json/', {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`API error: ${data.reason || data.error}`);
                }
                
                if (data.latitude && data.longitude) {
                    const result = findClosestLocation(data.latitude, data.longitude);
                    console.log(`IP geolocation detected: ${data.city}, ${data.region} (${data.latitude}, ${data.longitude})`);
                    console.log(`Closest location: ${result.location} (${result.distance.toFixed(1)} miles away)`);
                    return result.location;
                }
                
                // Fallback: try to match by city/state if coordinates aren't available
                if (data.city && data.region_code) {
                    const cityState = `${data.city.toLowerCase()}, ${data.region_code.toLowerCase()}`;
                    console.log(`Attempting city/state match for: ${cityState}`);
                    
                    for (const [locationKey, locationData] of Object.entries(locationConfig)) {
                        const locationCityState = `${locationData.city.toLowerCase()}, ${locationData.state.toLowerCase()}`;
                        if (cityState.includes(locationData.city.toLowerCase()) && 
                            data.region_code.toLowerCase() === locationData.state.toLowerCase()) {
                            console.log(`Matched by city/state: ${locationKey}`);
                            return locationKey;
                        }
                    }
                }
                
                throw new Error('Could not determine location from IP data - insufficient location information');
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('IP geolocation request timed out');
                }
                console.log('IP geolocation error:', error.message);
                throw error;
            }
        }

        /**
         * Main auto-detection function with enhanced error handling and user feedback
         * @returns {Promise<string>} Detected location key
         */
        async function autoDetectLocation() {
            console.log('Starting automatic location detection...');
            
            try {
                // First try HTML5 geolocation (most accurate)
                const location = await detectLocationByGeolocation();
                console.log(`Auto-detected location via geolocation: ${location}`);
                showToast('success', 'Location Detected', `Automatically detected your location as ${locationConfig[location]?.city || location}`, 3000);
                return location;
            } catch (geolocationError) {
                console.log('Geolocation failed, trying IP-based detection...');
                
                try {
                    // Fallback to IP-based geolocation
                    const location = await detectLocationByIP();
                    console.log(`Auto-detected location via IP: ${location}`);
                    showToast('info', 'Location Detected', `Detected your approximate location as ${locationConfig[location]?.city || location} via IP`, 3000);
                    return location;
                } catch (ipError) {
                    console.log('All location detection methods failed, using default (Wichita)');
                    showToast('warning', 'Location Detection Failed', 'Using default location (Wichita). You can manually select your location above.', 4000);
                    return 'wichita'; // Default fallback
                }
            }
        }

        /**
         * Get currently selected location from radio buttons
         * @returns {string} Selected location key or 'wichita' as default
         */
        function getSelectedLocation() {
            const selectedRadio = document.querySelector('input[name="location"]:checked');
            return selectedRadio ? selectedRadio.value : 'wichita'; // Default to Wichita
        }

        /**
         * Select a location and update the UI accordingly
         * @param {string} locationValue - Location key to select
         */
        function selectLocation(locationValue) {
            // Update radio button
            const radioButton = document.getElementById(`location-${locationValue}`);
            if (radioButton) {
                radioButton.checked = true;
            }
            
            // Update visual selection
            document.querySelectorAll('.location-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`input[value="${locationValue}"]`)?.closest('.location-option');
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Update email addresses
            updateLocationEmails();
        }

        /**
         * Update email addresses in modal based on selected location
         */
        function updateLocationEmails() {
            const selectedLocation = getSelectedLocation();
            const config = locationConfig[selectedLocation];
            
            if (config) {
                // Update BPC email
                const bpcCheckbox = document.getElementById('backPartsCounter');
                if (bpcCheckbox) {
                    bpcCheckbox.value = config.bpc;
                }
                
                // Update Service Admin email
                const serviceAdminCheckbox = document.getElementById('serviceAdminTeam');
                if (serviceAdminCheckbox) {
                    serviceAdminCheckbox.value = config.serviceAdmin;
                }
            }
        }

        /**
         * Creates a mailto link based on the email type
         * @param {string} type - Type of email ('note', 'notify', 'status')
         */
        function createMailto(type) {
            if (type === 'notify') {
                // Show the notification modal for the second option
                document.getElementById('notificationModal').style.display = 'flex';
                return;
            }
            
            // For other options, show case number modal
            openCaseNumberModal(type);
        }

        /**
         * Processes the notification email with validation and toast feedback
         */
        function processNotificationEmail() {
            const caseNumber = document.getElementById('modalCaseNumber').value;
            const selectedEmails = document.querySelectorAll('input[name="notifyEmail"]:checked');
            
            if (!caseNumber || caseNumber.trim() === '') {
                showToast('warning', 'Missing Information', 'Please enter a case number.');
                return;
            }
            
            if (selectedEmails.length === 0) {
                showToast('warning', 'Missing Recipients', 'Please select at least one recipient to notify.');
                return;
            }
            
            // Validate case number
            const validation = validateCaseNumber(caseNumber);
            
            if (!validation.isValid) {
                showToast('error', 'Invalid Case Number', validation.error);
                return;
            }
            
            // Get selected email addresses
            const selectedEmailAddresses = Array.from(selectedEmails).map(checkbox => checkbox.value);
            
            // Close modal
            closeModal();
            
            // Process the email
            try {
                processEmail('notify', validation.cleaned, selectedEmailAddresses);
                showToast('success', 'Email Generated', 'Your email client should open with the pre-filled notification.');
            } catch (err) {
                console.error('Error processing notification email:', err);
                showToast('error', 'Email Error', 'There was an error generating the email. Please try again.');
            }
        }

        /**
         * Closes the notification modal and clears form data
         */
        function closeModal() {
            document.getElementById('notificationModal').style.display = 'none';
            // Clear form
            document.getElementById('modalCaseNumber').value = '';
            const checkboxes = document.querySelectorAll('input[name="notifyEmail"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // Email template configuration
        const emailTemplates = {
            note: {
                subject: (caseNumber) => caseNumber,
                body: (caseNumber) => `Adding a new notation to Case #${caseNumber}

Adding the following note to this case:

[Enter your note below and delete this line] Note: Attaching any files or images to this email will add them to the case.

---
This email was generated by the Decisiv Case Notation Tool`
            },
            notify: {
                subject: (caseNumber) => caseNumber,
                body: (caseNumber) => `Adding a new notation with attachments to Case # ${caseNumber}

Adding the following note and attached files to this case:

Note: 

Attachments: [Attach any relevant files or images to this email]

---
This email was generated by the Decisiv Case Notation Tool`
            },
            status: {
                subject: (caseNumber) => caseNumber,
                body: (caseNumber) => `Service Diagnosis and Parts Update for Case #${caseNumber}

1. Diagnosis and Findings - 
[Enter your diagnosis and findings here]

2. Parts list - 
   a. [Part name/number - description]
   b. [Part name/number - description]
   c. [Part name/number - description]
   d. [Part name/number - description]

3. Additional Notes - 
[Enter any additional notes or observations here]

---
This email was generated by the Decisiv Case Notation Tool`
            }
        };

        /**
         * Processes and generates email based on type, case number, and recipients
         * @param {string} type - Email type ('note', 'notify', 'status')
         * @param {string} caseNumber - Validated case number
         * @param {Array<string>|null} ccEmails - Email addresses to CC
         */
        function processEmail(type, caseNumber, ccEmails) {
            try {
                // Email details
                const toEmail = 'Cases@replies.decisivapps.com';
                let ccList = [];
                
                // For 'notify' type, add selected emails to CC
                if (type === 'notify' && ccEmails && ccEmails.length > 0) {
                    ccList = ccList.concat(ccEmails);
                }
                
                // For 'status' type, add BPC to CC
                if (type === 'status') {
                    const selectedLocation = getSelectedLocation();
                    const config = locationConfig[selectedLocation];
                    if (config && config.bpc) {
                        ccList.push(config.bpc);
                    }
                }
                
                // Get email template
                const template = emailTemplates[type];
                if (!template) {
                    throw new Error(`Unknown email type: ${type}`);
                }
                
                const subject = template.subject(caseNumber);
                const emailBody = template.body(caseNumber);
                
                // Create mailto URL with CC
                let mailtoUrl = `mailto:${toEmail}?subject=${encodeURIComponent(subject)}`;
                
                if (ccList.length > 0) {
                    const ccString = ccList.join(';');
                    mailtoUrl += `&cc=${encodeURIComponent(ccString)}`;
                }
                
                mailtoUrl += `&body=${encodeURIComponent(emailBody)}`;
                
                // Open email client
                window.location.href = mailtoUrl;
                
                console.log(`Email generated successfully for case ${caseNumber}, type: ${type}`);
                
            } catch (error) {
                console.error('Error in processEmail:', error);
                throw error; // Re-throw to be handled by caller
            }
        }
        
        // Hide error message on page load
        document.addEventListener('DOMContentLoaded', function() {
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
            
            // Initialize location selection with auto-detection
            initializeLocationSelection();
            
            // Close modals when clicking outside of them
            document.getElementById('notificationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('caseNumberModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCaseNumberModal();
                }
            });
            
            // Close user guide modal when clicking outside of it
            document.getElementById('userGuideModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUserGuide();
                }
            });
            
            // Add keyboard support for case number modal
            document.getElementById('caseNumberInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCaseNumber();
                } else if (e.key === 'Escape') {
                    closeCaseNumberModal();
                }
            });
            
            // Add real-time validation feedback for case number input
            document.getElementById('caseNumberInput').addEventListener('input', function(e) {
                const input = e.target;
                const error = document.getElementById('caseNumberError');
                
                // Clear error state when user starts typing
                if (input.classList.contains('error')) {
                    input.classList.remove('error');
                    error.style.display = 'none';
                }
                
                // Only allow numeric input
                const cleaned = input.value.replace(/\D/g, '');
                if (input.value !== cleaned) {
                    input.value = cleaned;
                }
            });
        });

        /**
         * Initialize location selection with auto-detection and enhanced error handling
         */
        async function initializeLocationSelection() {
            // Show loading indicator
            const statusElement = document.getElementById('locationStatus');
            if (statusElement) {
                statusElement.style.display = 'block';
            }
            console.log('Initializing location detection...');
            
            try {
                const detectedLocation = await autoDetectLocation();
                selectLocation(detectedLocation);
                
                // Hide loading indicator
                if (statusElement) {
                    statusElement.style.display = 'none';
                }
                
                // Show a subtle notification about auto-detection (only if not already shown by autoDetectLocation)
                // showLocationNotification(detectedLocation);
            } catch (error) {
                console.error('Location detection failed:', error);
                
                // Hide loading indicator
                if (statusElement) {
                    statusElement.style.display = 'none';
                }
                
                // Fall back to default (Wichita)
                selectLocation('wichita');
                showToast('error', 'Location Detection Error', 'Failed to detect location. Using default location (Wichita).', 4000);
            }
        }

        // Show a subtle notification about auto-detected location
        function showLocationNotification(location) {
            const locationName = locationConfig[location]?.city || location;
            
            // Create notification element
            const notification = document.createElement('div');
            notification.innerHTML = `üìç Auto-detected location: <strong>${locationName}</strong> (you can change this above)`;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: rgba(0, 230, 118, 0.9);
                color: white;
                padding: 12px 20px;
                border-radius: 12px;
                font-size: 0.9em;
                font-weight: 500;
                box-shadow: 0 4px 20px rgba(0, 230, 118, 0.3);
                backdrop-filter: blur(10px);
                z-index: 1500;
                opacity: 0;
                transition: all 0.3s ease;
                max-width: 300px;
                line-height: 1.4;
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // User Guide Modal Functions
        function openUserGuide() {
            const modal = document.getElementById('userGuideModal');
            const content = document.getElementById('userGuideContent');
            
            // Populate content
            content.innerHTML = getUserGuideHTML();
            
            // Show modal
            modal.style.display = 'flex';
            
            // Prevent body scrolling
            document.body.style.overflow = 'hidden';
        }

        function closeUserGuide() {
            const modal = document.getElementById('userGuideModal');
            modal.style.display = 'none';
            
            // Restore body scrolling
            document.body.style.overflow = 'auto';
        }

        function getUserGuideHTML() {
            return `
                <h2>üöÄ Getting Started</h2>
                
                <h3>Opening the Tool</h3>
                <ol>
                    <li><strong>Open the Application</strong> in any modern web browser (Chrome, Firefox, Edge, Safari)</li>
                    <li><strong>Allow location permissions</strong> when prompted for automatic location detection (optional but recommended)</li>
                    <li>The tool will automatically detect your location and select the appropriate WKI location</li>
                </ol>

                <h2>üè¢ Location Selection</h2>
                
                <h3>Automatic Detection</h3>
                <p>When you first load the page, the tool will:</p>
                <ol>
                    <li><strong>Show a loading spinner</strong> "üîÑ Detecting your location..."</li>
                    <li><strong>Request location permission</strong> (GPS/WiFi-based detection)</li>
                    <li><strong>Fall back to IP detection</strong> if GPS is denied</li>
                    <li><strong>Auto-select the closest location</strong> from: Wichita, Dodge City, Liberal, Emporia</li>
                </ol>

                <h3>Manual Override</h3>
                <ul>
                    <li><strong>Click any location button</strong> to manually select your location</li>
                    <li><strong>Selected location</strong> will be highlighted in green</li>
                    <li><strong>Email addresses automatically update</strong> based on your selection</li>
                </ul>

                <h3>Location-Specific Email Routing</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th>BPC Email</th>
                            <th>Service Admin Email</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Wichita</strong></td>
                            <td>WIC-BPC@WichitaKenworth.com</td>
                            <td>WichitaServiceAdmin@WichitaKenworth.com</td>
                        </tr>
                        <tr>
                            <td><strong>Dodge City</strong></td>
                            <td>DOD-BPC@DodgeCityKenworth.com</td>
                            <td>DCServiceAdmin@DodgeCityKenworth.com</td>
                        </tr>
                        <tr>
                            <td><strong>Liberal</strong></td>
                            <td>LIB-BPC@LiberalKenworth.com</td>
                            <td>LiberalServiceAdmin@WichitaKenworth.com</td>
                        </tr>
                        <tr>
                            <td><strong>Emporia</strong></td>
                            <td>Parts@EmporiaKenworth.com</td>
                            <td>EmporiaServiceAdmin@WichitaKenworth.com</td>
                        </tr>
                    </tbody>
                </table>

                <h2>üìß Email Types & Functions</h2>

                <h3>1. üìù Add Note</h3>
                <p><strong>Purpose:</strong> Simple note addition to a Decisiv case</p>
                
                <p><strong>How to use:</strong></p>
                <ol>
                    <li>Click the <strong>green "Add Note"</strong> button</li>
                    <li>Enter the <strong>case number</strong> when prompted (numbers only)</li>
                    <li>Your default email client opens with pre-formatted template</li>
                </ol>

                <p><strong>Email Recipients:</strong></p>
                <ul>
                    <li>‚úÖ Decisiv Case Update system only</li>
                    <li>‚ùå No team notifications</li>
                </ul>

                <p><strong>Use cases:</strong> Adding documentation, attaching photos/files, simple status updates</p>

                <h3>2. üìé Add Note and Notify</h3>
                <p><strong>Purpose:</strong> Add a note AND notify your team members</p>
                
                <p><strong>How to use:</strong></p>
                <ol>
                    <li>Click the <strong>blue "Add Note and Notify"</strong> button</li>
                    <li><strong>Modal window opens</strong> with case number input and notification options</li>
                    <li><strong>Enter case number</strong> (numbers only)</li>
                    <li><strong>Select recipients:</strong> Back Parts Counter and/or Service Admin Team</li>
                    <li>Click <strong>"Generate Email"</strong></li>
                </ol>

                <p><strong>Email Recipients:</strong></p>
                <ul>
                    <li>‚úÖ Decisiv Case Update system</li>
                    <li>‚úÖ Selected team members (location-specific emails)</li>
                </ul>

                <p><strong>Use cases:</strong> Requesting parts assistance, notifying management, coordinating team responses</p>

                <h3>3. üîß Service Diag and Parts Update</h3>
                <p><strong>Purpose:</strong> Comprehensive diagnostic report with parts information</p>
                
                <p><strong>How to use:</strong></p>
                <ol>
                    <li>Click the <strong>orange "Service Diag and Parts Update"</strong> button</li>
                    <li>Enter the <strong>case number</strong> when prompted</li>
                    <li>Email opens with <strong>structured template</strong> including diagnosis, parts list, and notes sections</li>
                </ol>

                <p><strong>Email Recipients:</strong></p>
                <ul>
                    <li>‚úÖ Decisiv Case Update system</li>
                    <li>‚úÖ Back Parts Counter (automatically included, location-specific)</li>
                </ul>

                <p><strong>Use cases:</strong> Technical diagnostic reports, parts ordering requests, detailed service updates</p>

                <h2>üõ†Ô∏è Troubleshooting</h2>

                <h3>Location Detection Issues</h3>
                <p><strong>Problem:</strong> Location detection fails or selects wrong location</p>
                <p><strong>Solution:</strong></p>
                <ul>
                    <li>Manually click the correct location button</li>
                    <li>Check browser location permissions</li>
                    <li>Refresh the page to retry detection</li>
                </ul>

                <h3>Email Client Issues</h3>
                <p><strong>Problem:</strong> Email doesn't open or opens in wrong client</p>
                <p><strong>Solution:</strong></p>
                <ul>
                    <li>Set default email client in Windows settings</li>
                    <li>Copy the case number and create email manually</li>
                    <li>Ensure Cases@replies.decisivapps.com is in your contacts</li>
                </ul>

                <h3>Case Number Validation</h3>
                <p><strong>Problem:</strong> "Please enter a valid case number" error</p>
                <p><strong>Solution:</strong></p>
                <ul>
                    <li>Use numbers only (no letters or special characters)</li>
                    <li>Remove any spaces or dashes</li>
                    <li>Example: Use "12345" not "Case-12345"</li>
                </ul>

                <h2>üì± Mobile Usage</h2>
                <p>The tool is fully responsive and works on mobile devices:</p>
                <ul>
                    <li><strong>Touch-friendly</strong> location selection</li>
                    <li><strong>Mobile-optimized</strong> button layout</li>
                    <li><strong>Responsive design</strong> adapts to screen size</li>
                    <li><strong>Same functionality</strong> as desktop version</li>
                </ul>

                <h2>üîí Security & Privacy</h2>

                <h3>Data Privacy</h3>
                <ul>
                    <li><strong>No case data stored</strong> locally or externally</li>
                    <li><strong>Location detection</strong> only used for routing decisions</li>
                    <li><strong>Geolocation cached</strong> for 5 minutes maximum</li>
                    <li><strong>All data processing</strong> happens in your browser</li>
                </ul>

                <h3>Access Control</h3>
                <ul>
                    <li><strong>WKI Internal Use Only</strong> - proprietary application</li>
                    <li><strong>Unauthorized access prohibited</strong></li>
                    <li><strong>Professional use only</strong> for Decisiv case management</li>
                </ul>

                <h2>‚ö° Quick Reference</h2>

                <h3>Email Format Examples</h3>
                <pre><code>TO: Cases@replies.decisivapps.com
SUBJECT: 12345
CC: WIC-BPC@WichitaKenworth.com (when applicable)</code></pre>

                <h3>Supported Browsers</h3>
                <ul>
                    <li>‚úÖ Chrome 90+</li>
                    <li>‚úÖ Firefox 88+</li>
                    <li>‚úÖ Edge 90+</li>
                    <li>‚úÖ Safari 14+</li>
                    <li>‚úÖ Mobile browsers</li>
                </ul>

                <h2>üìû Support</h2>
                <p>For technical issues or questions:</p>
                <ol>
                    <li><strong>Check this user guide</strong> first</li>
                    <li><strong>Contact WKI Decisiv Champion (Mike Agnew)</strong> for technical support</li>
                    <li><strong>Contact Service Management</strong> for process questions</li>
                </ol>

                <hr style="margin: 30px 0; border: 1px solid rgba(255,255,255,0.1);">
                <p style="text-align: center; font-style: italic; color: #64ffda;">
                    <em>This tool was built specifically for WKI Service Department Excellence and streamlined case management workflows.</em>
                </p>
            `;
        }
    </script>
</body>
</html>
